---
layout: post
title:  "JSON.parse() 不得不说的坑"
date:   2016-07-17 13:46:00 +0800
categories: jekyll update
---

今天有个服务端的同学找我解决一个PHP里`json_decode()`方法的问题，问题很简单，一个JSON字符串，通过`json_decode()`方法解析后，变为了`NULL`。

根据我“多年”跟JSON打交道的经验，得先验明这个JSON正身，于是粘贴字符串到 [http://jsonlint.com/](http://jsonlint.com/)。只见绿油油的一行小字`Valid JSON`。

我承认，在那0.00001秒内，我是懵逼的。但凡事总有个原因对吧，扫了一眼这个JSON字符串，嗯，有个Windows文件路径在里面，也就是说有反斜杠，应该就是它在作祟。那就先对这个字符串做一下`json_encode()`，再进行`json_decode()`，Done，问题解决了。甩甩袖子就起身回工位（大夏天穿长袖你是有病么）。

作为有追求的程序员，肯定不能善罢甘休的，明明一个验证通过的JSON，怎么就不能`json_decode()`了呢。于是做了一个试验：（PHP环境木有，拿个JS的凑合下，原理是一样的，解析器都是遵循 [json.org](http://json.org/) 来实现的）

![试验](http://p0.qhimg.com/t01d39e8c0de7f05267.png)

有些小伙伴可能已经发现问题所在了，看似一个简单的反斜杠`\`，想要在`JSON.parse()`中正确解析出来，需要在定义JSON字符串的时候写四个反斜杠，也即`\\\\ => \`。

原因出在定义字符串这个动作。当我们令

```javascript
a = '\\'
```

此时，我们得到一个变量`a`，其类型为字符串，长度为`1`，奏是它

```
\
```

单独的一个反斜杠肯定不是一个有效的JSON，根据 [json.org](http://json.org/) 的规定，起码两边要加上一对双引号。好，我们令

```javascript
a = '"\\"';
```

得到

```javascript
"\"
```

但是。。。它就是一个合法的JSON了么，显然不是啊，根据JSON的语法规定，反斜杠是个转义符号，你把右边的双引号转义掉了，显然双引号就不闭合了啊。

到此，问题其实很明显了，我们在定义一个字符串，并将它交给JSON解析器解析的时候，必须用两个反斜杠来代替原来的一个反斜杠，因为`我们在定义字符串变量的时候，发生了一次转义，写在代码中的\\到JSON解析器中变成了一个反斜杠，显然JSON解析器还会再做一次转义，这就是为何我们要写四个反斜杠来表示一个反斜杠`。

那还有两个问题：

1. 如何避免这个问题。答：如果自己本地定义的JSON字符串，记住上面的原则，double一下你的反斜杠，或者先`JSON.stringify()`一次；如果是远程传过来的，一般远程在传过来之前都会进行一次`JSON.stringify()`，所以就无需担心这个问题了，适当加上错误的捕获处理就可以了。

2. 为何把那串JSON字符串放到  [jsonlint](http://jsonlint.com) 上得到是个合法的JSON。答：因为你复制过去的是到一个文本框中，而不是赋值给一个变量，相当于跳过了一次转义。

